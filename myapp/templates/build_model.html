{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
<style>
    .upload-section {
        text-align: center;
        margin-bottom: 3rem;
    }

    .drop-zone {
        border: 2px dashed var(--border);
        border-radius: 16px;
        padding: 3rem 2rem;
        background: var(--surface);
        transition: all 0.2s;
        cursor: pointer;
        margin-bottom: 2rem;
    }

    .drop-zone.hover {
        border-color: var(--primary);
        background: var(--background);
    }

    .drop-zone-text {
        font-size: 1.1rem;
        color: var(--text-secondary);
        margin-bottom: 1rem;
    }

    .browse-btn {
        color: var(--primary);
        text-decoration: underline;
        cursor: pointer;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .loading-overlay.show {
        display: flex;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid var(--background);
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .result-section {
        margin-bottom: 3rem;
    }

    .data-preview {
        overflow-x: auto;
        background: var(--surface);
        border-radius: 16px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        margin-bottom: 2rem;
    }

    .data-preview table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-preview th,
    .data-preview td {
        padding: 0.75rem 1rem;
        text-align: left;
        border-bottom: 1px solid var(--border);
    }

    .data-preview th {
        background: var(--background);
        font-weight: 600;
    }

    .model-config {
        background: var(--surface);
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .model-config h3 {
        font-size: 1.5rem;
        margin-bottom: 2rem;
        color: var(--text);
        text-align: center;
    }

    .download-section {
        text-align: center;
        margin-top: 2rem;
    }

    .accuracy-display {
        font-size: 1.2rem;
        color: var(--text);
        margin-bottom: 1rem;
    }

    .accuracy-value {
        font-weight: 600;
        color: var(--primary);
    }
</style>
{% endblock %}

{% block content %}
<div class="upload-section">
    <h2 class="page-title">Build Your Machine Learning Model</h2>
    <div id="drop-zone" class="drop-zone">
        <p class="drop-zone-text">
            Drag and drop your CSV file here or 
            <span class="browse-btn" id="browse-button">browse files</span>
        </p>
    </div>
    <input type="file" id="file-input" accept=".csv" style="display: none;">
</div>

<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
</div>

<div class="result-section">
    <div id="result" class="data-preview"></div>
    
    <div id="ml-form" class="model-config" style="display: none;">
        <h3>Configure Your Model</h3>
        <form id="ml-config">
            <div class="form-group">
                <label class="form-label" for="target-column">Target Column</label>
                <select id="target-column" name="target_column" class="form-control" required>
                    <!-- Will be populated dynamically -->
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="problem-type">Problem Type</label>
                <select id="problem-type" name="problem_type" class="form-control" required>
                    <option value="classification">Classification</option>
                    <option value="regression">Regression</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="file-format">File Format</label>
                <select id="file-format" name="file_format" class="form-control" required>
                    <option value="pkl">Pickle (.pkl)</option>
                    <option value="joblib">Joblib (.joblib)</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Build Model</button>
        </form>
    </div>

    <div id="download-section" class="download-section" style="display: none;">
        <p class="accuracy-display">Model Accuracy: <span id="model-accuracy" class="accuracy-value"></span></p>
        <button id="download-button" class="btn btn-primary">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="margin-right: 0.5rem;">
                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
            </svg>
            Download Model
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        $('#drop-zone').on('dragover', function(event) {
            event.preventDefault();
            $(this).addClass('hover');
        });

        $('#drop-zone').on('dragleave', function(event) {
            $(this).removeClass('hover');
        });

        $('#browse-button').on('click', function() {
            $('#file-input').click();
        });

        function handleFileUpload(file) {
            var formData = new FormData();
            formData.append('file', file);
            formData.append('csrfmiddlewaretoken', csrftoken);

            $('#loadingOverlay').addClass('show');

            $.ajax({
                url: '/upload-csv/',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                timeout: 10000,
                success: function(response) {
                    $('#loadingOverlay').removeClass('show');
                    
                    console.log('Available columns:', response.columns);
                    
                    $('#result').html(response.description);
                    response.plots.forEach(function(plot) {
                        $('#result').append(plot);
                    });
                    
                    const targetSelect = $('#target-column');
                    targetSelect.empty();
                    response.columns.forEach(function(column) {
                        targetSelect.append($('<option>', {
                            value: column,
                            text: column
                        }));
                    });
                    $('#ml-form').show();
                },
                error: function(xhr, status, error) {
                    $('#loadingOverlay').removeClass('show');
                    $('#result').html('An error occurred while processing the file.');
                }
            });
        }

        $('#drop-zone').on('drop', function(event) {
            event.preventDefault();
            $(this).removeClass('hover');

            var files = event.originalEvent.dataTransfer.files;
            if (files.length) {
                handleFileUpload(files[0]);
            }
        });

        $('#file-input').on('change', function(event) {
            var files = event.target.files;
            if (files.length) {
                handleFileUpload(files[0]);
            }
        });

        let modelBlob = null;
        let modelFilename = null;

        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        $('#ml-config').on('submit', function(event) {
            event.preventDefault();
            
            const formData = {
                target_column: $('#target-column').val(),
                problem_type: $('#problem-type').val(),
                file_format: $('#file-format').val()
            };

            $('#loadingOverlay').addClass('show');

            fetch('/build-model-api/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                const accuracy = response.headers.get('X-Model-Accuracy');
                if (accuracy) {
                    $('#model-accuracy').text((parseFloat(accuracy) * 100).toFixed(2) + '%');
                    $('#download-section').show();
                }
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `model_${formData.target_column}_${formData.problem_type}.${formData.file_format}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                $('#loadingOverlay').removeClass('show');
            })
            .catch(error => {
                $('#loadingOverlay').removeClass('show');
                alert('Error building model: ' + error);
            });
        });

        $('#download-button').on('click', function() {
            if (modelBlob && modelFilename) {
                const url = window.URL.createObjectURL(modelBlob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', modelFilename);
                document.body.appendChild(link);
                link.click();
                link.remove();
            }
        });
    });
</script>
{% endblock %}
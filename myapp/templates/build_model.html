{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
{% endblock %}

{% block content %}
<div class="upload-section">
    <h2 class="page-title">Build Your Machine Learning Model</h2>
    <div id="drop-zone" class="drop-zone">
        <div class="drop-zone-content">
            <p class="drop-zone-text">
                Drag and drop your CSV file here or browse files
            </p>
        </div>
    </div>
    <input type="file" id="file-input" accept=".csv" style="display: none;">
    
    <!-- Add validation status display -->
    <div id="validation-status" style="display: none;" class="validation-status">
        <div class="validation-icon"></div>
        <p class="validation-message"></p>
    </div>
</div>

<div id="loadingOverlay" class="loading-overlay">
    <div style="display: flex; align-items: center;">
        <div class="loading-spinner"></div>
        <div class="loading-text">Uploading and processing your CSV file...</div>
    </div>
</div>

<div class="result-section">
    <div id="result" class="data-preview"></div>
    
    <div id="ml-form" class="model-config" style="display: none;">
        <h3>Configure Your Model</h3>
        <form id="ml-config">
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label" for="target-column">Target Column</label>
                    <select id="target-column" name="target_column" class="form-control" required>
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="problem-type">Problem Type</label>
                    <select id="problem-type" name="problem_type" class="form-control" required>
                        <option value="classification">Classification</option>
                        <option value="regression">Regression</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="evaluation-metric">Evaluation Metric</label>
                    <select id="evaluation-metric" name="evaluation_metric" class="form-control" required>
                        <optgroup label="Classification Metrics" class="classification-metrics">
                            <option value="accuracy">Accuracy</option>
                            <option value="precision">Precision (P)</option>
                            <option value="recall">Recall (R)</option>
                            <option value="f1">F1 score (F1)</option>
                            <option value="auc">Area Under Curve (AUC)</option>
                        </optgroup>
                        <optgroup label="Regression Metrics" class="regression-metrics">
                            <option value="r2">R² Score</option>
                            <option value="mse">Mean Squared Error</option>
                            <option value="rmse">Root Mean Squared Error</option>
                            <option value="mae">Mean Absolute Error</option>
                        </optgroup>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="file-format">File Format</label>
                    <select id="file-format" name="file_format" class="form-control" required>
                        <option value="joblib">Joblib (.joblib)</option>
                        <option value="pkl">Pickle (.pkl)</option>
                    </select>
                </div>
            </div>
            <button type="submit" id="build-model-btn" class="btn btn-primary" style="width: 100%;" disabled>Build Model</button>
        </form>
    </div>

    <div id="download-section" class="download-section" style="display: none;">
        <p class="accuracy-display">Model Accuracy: <span id="model-accuracy" class="accuracy-value"></span></p>
        
        <div class="options-container">
            <!-- Free Download Option -->
            <div class="option-card free">
                <h3>Download Model</h3>
                <p>Download your trained model and start using it right away.</p>
                <button id="download-button" class="btn btn-primary">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="margin-right: 0.5rem;">
                        <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                    </svg>
                    Download Model
                </button>
            </div>
            
            <!-- Premium Option -->
            <div class="option-card premium">
                <div class="premium-badge">PREMIUM</div>
                <h3>Enhance Performance</h3>
                {% if request.user.userprofile.is_premium %}
                    <p>Configure advanced optimization techniques to improve your model's accuracy:</p>
                    <form id="enhance-config" class="enhance-form">
                        <div class="enhance-options">
                            <div class="enhance-option">
                                <label>
                                    <input type="checkbox" name="feature_engineering" checked>
                                    Advanced Feature Engineering
                                </label>
                                <span class="option-description">Automatically create and select the best features</span>
                            </div>
                            <div class="enhance-option">
                                <label>
                                    <input type="checkbox" name="hyperparameter_opt" checked>
                                    Hyperparameter Optimization
                                </label>
                                <span class="option-description">Find optimal model parameters</span>
                            </div>
                            <div class="enhance-option">
                                <label>
                                    <input type="checkbox" name="ensemble" checked>
                                    Ensemble Methods
                                </label>
                                <span class="option-description">Combine multiple models for better predictions</span>
                            </div>
                            <div class="enhance-option">
                                <label>
                                    <input type="checkbox" name="cross_validation" checked>
                                    Cross-validation
                                </label>
                                <span class="option-description">Ensure model reliability and prevent overfitting</span>
                            </div>
                        </div>
                        <button onclick="improveModel()" style="width: 100%; padding: 0.875rem; background: linear-gradient(to right, var(--orange), var(--red)); color: var(--actual-white); text-decoration: none; border-radius: 12px; font-weight: 500; transition: all 0.3s; border: none; outline: none; position: relative; overflow: hidden; cursor: pointer; margin-top: 1rem;">
                            Start Enhancement
                        </button>
                    </form>
                {% else %}
                    <p>Unlock advanced optimization techniques to improve your model's accuracy by up to 30%!</p>
                    <ul>
                        <li>Advanced feature engineering</li>
                        <li>Hyperparameter optimization</li>
                        <li>Ensemble methods</li>
                        <li>Cross-validation</li>
                    </ul>
                    <button onclick="window.location.href='/premium'" class="btn premium-btn">
                        Upgrade & Improve
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        $('#drop-zone').on('dragover', function(event) {
            event.preventDefault();
            $(this).addClass('hover');
        });

        $('#drop-zone').on('dragleave', function(event) {
            $(this).removeClass('hover');
        });

        $('#drop-zone').on('click', function(event) {
            // Prevent click event if user is selecting text
            if (window.getSelection().toString()) {
                return;
            }
            $('#file-input').click();
        });

        function handleFileUpload(file) {
            if (!file.name.endsWith('.csv')) {
                showValidationStatus(false, 'Please upload a CSV file');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            // Show loading overlay
            document.getElementById('loadingOverlay').classList.add('show');
            
            $.ajax({
                url: '/upload-csv/',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'X-CSRFToken': csrftoken
                },
                success: function(response) {
                    // Hide loading overlay
                    document.getElementById('loadingOverlay').classList.remove('show');
                    
                    if (response.is_valid) {
                        // Hide validation status for valid files
                        $('#validation-status').hide();
                        $('#result').html(response.description);
                        response.plots.forEach(function(plot) {
                            $('#result').append(plot);
                        });
                        
                        const targetSelect = $('#target-column');
                        targetSelect.empty();
                        response.columns.forEach(function(column) {
                            targetSelect.append($('<option>', {
                                value: column,
                                text: column
                            }));
                        });
                        $('#ml-form').show();
                        document.getElementById('build-model-btn').disabled = false;
                    } else {
                        showValidationStatus(false, response.message);
                        $('#ml-form').hide();
                        $('#result').html('');
                    }
                },
                error: function(xhr) {
                    // Hide loading overlay
                    document.getElementById('loadingOverlay').classList.remove('show');
                    const response = xhr.responseJSON || {};
                    showValidationStatus(false, response.message || 'An error occurred while processing the file');
                    $('#ml-form').hide();
                    $('#result').html('');
                }
            });
        }

        $('#drop-zone').on('drop', function(event) {
            event.preventDefault();
            $(this).removeClass('hover');

            var files = event.originalEvent.dataTransfer.files;
            if (files.length) {
                handleFileUpload(files[0]);
            }
        });

        $('#file-input').on('change', function(event) {
            var files = event.target.files;
            if (files.length) {
                handleFileUpload(files[0]);
            }
        });

        let modelBlob = null;
        let modelFilename = null;

        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        $('#ml-config').on('submit', function(event) {
            event.preventDefault();
            
            const formData = {
                target_column: $('#target-column').val(),
                problem_type: $('#problem-type').val(),
                file_format: $('#file-format').val(),
                evaluation_metric: $('#evaluation-metric').val()
            };

            $('#loadingOverlay').addClass('show');

            fetch('/build-model-api/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`Server returned ${response.status}: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    $('#model-accuracy').text(
                        data.metric === 'accuracy' ? 
                        (data.score * 100).toFixed(2) + '%' : 
                        data.score.toFixed(4)
                    );
                    $('#download-section').show();
                    
                    // Set the model blob and filename from the response
                    fetch(data.model_url)
                        .then(response => response.blob())
                        .then(blob => {
                            modelBlob = blob;
                            modelFilename = data.filename || 'model.' + $('#file-format').val();
                        });
                } else {
                    throw new Error(data.error || 'Failed to build model');
                }
                $('#loadingOverlay').removeClass('show');
            })
            .catch(error => {
                $('#loadingOverlay').removeClass('show');
                console.error('Error details:', error);
                alert('Error building model: ' + error);
            });
        });

        $('#download-button').on('click', function() {
            if (modelBlob && modelFilename) {
                const url = window.URL.createObjectURL(modelBlob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = modelFilename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            }
        });

        document.getElementById('problem-type').addEventListener('change', function() {
            const problemType = this.value;
            const evaluationMetric = document.getElementById('evaluation-metric');
            
            // Clear existing options
            while (evaluationMetric.firstChild) {
                evaluationMetric.firstChild.remove();
            }
            
            if (problemType === 'classification') {
                const classificationMetrics = [
                    { value: 'accuracy', text: 'Accuracy' },
                    { value: 'precision', text: 'Precision (P)' },
                    { value: 'recall', text: 'Recall (R)' },
                    { value: 'f1', text: 'F1 score (F1)' },
                    { value: 'auc', text: 'Area Under Curve (AUC)' }
                ];
                
                classificationMetrics.forEach(metric => {
                    const option = document.createElement('option');
                    option.value = metric.value;
                    option.textContent = metric.text;
                    evaluationMetric.appendChild(option);
                });
                
                evaluationMetric.value = 'accuracy';
            } else {
                const regressionMetrics = [
                    { value: 'r2', text: 'R² Score' },
                    { value: 'mse', text: 'Mean Squared Error' },
                    { value: 'rmse', text: 'Root Mean Squared Error' },
                    { value: 'mae', text: 'Mean Absolute Error' }
                ];
                
                regressionMetrics.forEach(metric => {
                    const option = document.createElement('option');
                    option.value = metric.value;
                    option.textContent = metric.text;
                    evaluationMetric.appendChild(option);
                });
                
                evaluationMetric.value = 'r2';
            }
        });

        function showValidationStatus(isValid, message) {
            const validationStatus = document.getElementById('validation-status');
            validationStatus.style.display = 'flex';
            validationStatus.className = 'validation-status ' + (isValid ? 'valid' : 'invalid');
            validationStatus.querySelector('.validation-message').textContent = message;
            document.getElementById('build-model-btn').disabled = !isValid;
        }

        function improveModel() {
            event.preventDefault(); // Prevent form submission
            
            // Show loading state
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Analyzing...';
            button.disabled = true;
            
            // Get selected options
            const options = {
                feature_engineering: document.querySelector('input[name="feature_engineering"]').checked,
                hyperparameter_opt: document.querySelector('input[name="hyperparameter_opt"]').checked,
                ensemble: document.querySelector('input[name="ensemble"]').checked,
                cross_validation: document.querySelector('input[name="cross_validation"]').checked
            };
            
            // For now, just show a message that this feature is coming soon
            setTimeout(() => {
                const selectedOptions = Object.entries(options)
                    .filter(([_, value]) => value)
                    .map(([key, _]) => key.replace('_', ' '))
                    .join(', ');
                
                alert(`Model improvement feature coming soon!\nSelected optimizations: ${selectedOptions}\nOur AI will analyze your model and apply the selected optimizations to improve its performance.`);
                button.textContent = originalText;
                button.disabled = false;
            }, 1500);
            
            // TODO: When backend is ready, make API call with selected options
            /*
            fetch('/improve-model/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(options)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update UI with improved model metrics
                } else {
                    throw new Error(data.error || 'Failed to improve model');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error improving model: ' + error);
            })
            .finally(() => {
                button.textContent = originalText;
                button.disabled = false;
            });
            */
        }
    });
</script>
{% endblock %}

<style>
    .validation-status {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-top: 1rem;
        padding: 1.5rem;
        border-radius: 8px;
        font-weight: 600;
    }
    
    .validation-status.invalid {
        background-color: rgba(239, 68, 68, 0.15);
        border: 2px solid var(--red);
        color: var(--red);
    }
    
    .validation-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        position: relative;
    }
    
    .validation-status.invalid .validation-icon::before {
        content: '✕';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: var(--red);
        font-size: 18px;
    }
    
    .validation-message {
        margin: 0;
        font-size: 1.1rem;
        line-height: 1.4;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    @media (max-width: 768px) {
        .form-grid {
            grid-template-columns: 1fr;
        }
    }

    .enhance-options {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin: 1rem 0;
    }

    .enhance-option {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .enhance-option label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--white);
        font-weight: 500;
        cursor: pointer;
    }

    .enhance-option input[type="checkbox"] {
        width: 1.2rem;
        height: 1.2rem;
        accent-color: var(--orange);
        cursor: pointer;
    }

    .option-description {
        color: var(--off-white);
        font-size: 0.9rem;
        margin-left: 1.7rem;
    }

    .enhance-form {
        margin-top: 1rem;
    }
</style>
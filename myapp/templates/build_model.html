{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
{% endblock %}

{% block content %}
<div class="upload-section">
    <h2 class="page-title">Build Your Machine Learning Model</h2>
    <div id="drop-zone" class="drop-zone">
        <div class="drop-zone-content">
            <p class="drop-zone-text">
                Drag and drop your CSV file here or browse files
            </p>
        </div>
    </div>
    <input type="file" id="file-input" accept=".csv" style="display: none;">
</div>

<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
</div>

<div class="result-section">
    <div id="result" class="data-preview"></div>
    
    <div id="ml-form" class="model-config" style="display: none;">
        <h3>Configure Your Model</h3>
        <form id="ml-config">
            <div class="form-group">
                <label class="form-label" for="target-column">Target Column</label>
                <select id="target-column" name="target_column" class="form-control" required>
                    <!-- Will be populated dynamically -->
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="problem-type">Problem Type</label>
                <select id="problem-type" name="problem_type" class="form-control" required>
                    <option value="classification">Classification</option>
                    <option value="regression">Regression</option>
                </select>
            </div>
            <div class="form-group">
                <label for="evaluation-metric">Evaluation Metric:</label>
                <select class="form-control" id="evaluation-metric" name="evaluation_metric" required>
                    <optgroup label="Classification Metrics" class="classification-metrics">
                        <option value="accuracy">Accuracy</option>
                        <option value="precision">Precision (P)</option>
                        <option value="recall">Recall (R)</option>
                        <option value="f1">F1 score (F1)</option>
                        <option value="auc">Area Under Curve (AUC)</option>
                        <option value="log loss">Log loss</option>
                        <option value="p@k5">Precision at k (P@5)</option>
                        <option value="ap@k5">Average precision at k (AP@5)</option>
                        <option value="map@k5">Mean average precision at k (MAP@5)</option>
                    </optgroup>
                    <optgroup label="Regression Metrics" class="regression-metrics" style="display:none;">
                        <option value="mae">Mean absolute error (MAE)</option>
                        <option value="mse">Mean squared error (MSE)</option>
                        <option value="rmse">Root mean squared error (RMSE)</option>
                        <option value="rmsle">Root mean squared logarithmic error (RMSLE)</option>
                        <option value="mpe">Mean percentage error (MPE)</option>
                        <option value="mape">Mean absolute percentage error (MAPE)</option>
                        <option value="r2">R-square (RÂ²)</option>
                    </optgroup>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="file-format">File Format</label>
                <select id="file-format" name="file_format" class="form-control" required>
                    <option value="pkl">Pickle (.pkl)</option>
                    <option value="joblib">Joblib (.joblib)</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Build Model</button>
        </form>
    </div>

    <div id="download-section" class="download-section" style="display: none;">
        <p class="accuracy-display">Model Accuracy: <span id="model-accuracy" class="accuracy-value"></span></p>
        <button id="download-button" class="btn btn-primary">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="margin-right: 0.5rem;">
                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
            </svg>
            Download Model
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        $('#drop-zone').on('dragover', function(event) {
            event.preventDefault();
            $(this).addClass('hover');
        });

        $('#drop-zone').on('dragleave', function(event) {
            $(this).removeClass('hover');
        });

        $('#drop-zone').on('click', function(event) {
            // Prevent click event if user is selecting text
            if (window.getSelection().toString()) {
                return;
            }
            $('#file-input').click();
        });

        function handleFileUpload(file) {
            var formData = new FormData();
            formData.append('file', file);
            formData.append('csrfmiddlewaretoken', csrftoken);

            $('#loadingOverlay').addClass('show');

            $.ajax({
                url: '/upload-csv/',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                timeout: 10000,
                success: function(response) {
                    $('#loadingOverlay').removeClass('show');
                    
                    console.log('Available columns:', response.columns);
                    
                    $('#result').html(response.description);
                    response.plots.forEach(function(plot) {
                        $('#result').append(plot);
                    });
                    
                    const targetSelect = $('#target-column');
                    targetSelect.empty();
                    response.columns.forEach(function(column) {
                        targetSelect.append($('<option>', {
                            value: column,
                            text: column
                        }));
                    });
                    $('#ml-form').show();
                },
                error: function(xhr, status, error) {
                    $('#loadingOverlay').removeClass('show');
                    $('#result').html('An error occurred while processing the file.');
                }
            });
        }

        $('#drop-zone').on('drop', function(event) {
            event.preventDefault();
            $(this).removeClass('hover');

            var files = event.originalEvent.dataTransfer.files;
            if (files.length) {
                handleFileUpload(files[0]);
            }
        });

        $('#file-input').on('change', function(event) {
            var files = event.target.files;
            if (files.length) {
                handleFileUpload(files[0]);
            }
        });

        let modelBlob = null;
        let modelFilename = null;

        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        $('#ml-config').on('submit', function(event) {
            event.preventDefault();
            
            const formData = {
                target_column: $('#target-column').val(),
                problem_type: $('#problem-type').val(),
                file_format: $('#file-format').val(),
                evaluation_metric: $('#evaluation-metric').val()
            };

            $('#loadingOverlay').addClass('show');

            fetch('/build-model-api/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`Server returned ${response.status}: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    $('#model-accuracy').text(
                        data.metric === 'accuracy' ? 
                        (data.score * 100).toFixed(2) + '%' : 
                        data.score.toFixed(4)
                    );
                    $('#download-section').show();
                } else {
                    throw new Error(data.error || 'Failed to build model');
                }
                $('#loadingOverlay').removeClass('show');
            })
            .catch(error => {
                $('#loadingOverlay').removeClass('show');
                console.error('Error details:', error);
                alert('Error building model: ' + error);
            });
        });

        $('#download-button').on('click', function() {
            if (modelBlob && modelFilename) {
                const url = window.URL.createObjectURL(modelBlob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = modelFilename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            }
        });

        document.getElementById('problem-type').addEventListener('change', function() {
            const classificationMetrics = document.querySelector('.classification-metrics');
            const regressionMetrics = document.querySelector('.regression-metrics');
            const evaluationMetric = document.getElementById('evaluation-metric');
            
            if (this.value === 'classification') {
                classificationMetrics.style.display = '';
                regressionMetrics.style.display = 'none';
                evaluationMetric.value = 'accuracy';
            } else {
                classificationMetrics.style.display = 'none';
                regressionMetrics.style.display = '';
                evaluationMetric.value = 'r2';
            }
        });
    });
</script>
{% endblock %}
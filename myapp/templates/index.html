{% extends 'base.html' %}
{% load static %}

{% block content %}
    <div id="drop-zone">
        Drag and drop a CSV file here or
        <button type="button" id="browse-button">browse files</button>
    </div>
    <input type="file" id="file-input" accept=".csv" style="display: none;">
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    
    <div id="result"></div>
    <div id="ml-form" style="display: none;">
        <h3>Configure Machine Learning Model</h3>
        <form id="ml-config">
            <div class="form-group">
                <label for="target-column">Target Column:</label>
                <select id="target-column" name="target_column" required>
                    <!-- Will be populated dynamically -->
                </select>
            </div>
            <div class="form-group">
                <label for="problem-type">Problem Type:</label>
                <select id="problem-type" name="problem_type" required>
                    <option value="classification">Classification</option>
                    <option value="regression">Regression</option>
                </select>
            </div>
            <div class="form-group">
                <label for="file-format">File Format:</label>
                <select id="file-format" name="file_format" required>
                    <option value="pkl">Pickle (.pkl)</option>
                    <option value="joblib">Joblib (.joblib)</option>
                </select>
            </div>
            <button type="submit">Build Model</button>
        </form>
    </div>

    <div id="download-section" style="display: none;">
        <h3>Model Results:</h3>
        <p id="model-accuracy"></p>
        <button id="download-button" class="btn btn-primary">Download Model</button>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        $('#drop-zone').on('dragover', function(event) {
            event.preventDefault();
            $(this).addClass('hover');
        });

        $('#drop-zone').on('dragleave', function(event) {
            $(this).removeClass('hover');
        });

        $('#browse-button').on('click', function() {
            $('#file-input').click();
        });

        function handleFileUpload(file) {
            var formData = new FormData();
            formData.append('file', file);
            formData.append('csrfmiddlewaretoken', csrftoken);

            $('#loadingOverlay').addClass('show');

            $.ajax({
                url: '/upload-csv/',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                timeout: 10000,
                success: function(response) {
                    $('#loadingOverlay').removeClass('show');
                    
                    $('#result').html(response.description);
                    response.plots.forEach(function(plot) {
                        $('#result').append(plot);
                    });
                    
                    const targetSelect = $('#target-column');
                    targetSelect.empty();
                    response.columns.forEach(function(column) {
                        targetSelect.append($('<option>', {
                            value: column,
                            text: column
                        }));
                    });
                    $('#ml-form').show();
                },
                error: function(xhr, status, error) {
                    $('#loadingOverlay').removeClass('show');
                    $('#result').html('An error occurred while processing the file.');
                }
            });
        }

        $('#drop-zone').on('drop', function(event) {
            event.preventDefault();
            $(this).removeClass('hover');

            var files = event.originalEvent.dataTransfer.files;
            if (files.length) {
                handleFileUpload(files[0]);
            }
        });

        $('#file-input').on('change', function(event) {
            var files = event.target.files;
            if (files.length) {
                handleFileUpload(files[0]);
            }
        });

        let modelBlob = null;
        let modelFilename = null;

        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        $('#ml-config').on('submit', function(e) {
            e.preventDefault();
            showLoading();
            
            const formData = {
                target_column: $('#target-column').val(),
                problem_type: $('#problem-type').val(),
                file_format: $('#file-format').val()
            };

            $.ajax({
                url: '/build-model/',
                type: 'POST',
                data: JSON.stringify(formData),
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': csrftoken
                },
                xhrFields: {
                    responseType: 'blob'
                },
                success: function(response, status, xhr) {
                    modelBlob = response;
                    modelFilename = xhr.getResponseHeader('Content-Disposition').split('filename=')[1].replace(/"/g, '');
                    const accuracy = xhr.getResponseHeader('X-Model-Accuracy');
                    
                    $('#model-accuracy').text(`Model Accuracy: ${accuracy}`);
                    $('#download-section').show();
                    
                    hideLoading();
                },
                error: function(xhr, status, error) {
                    try {
                        const errorMsg = JSON.parse(xhr.responseText).error;
                        $('#result').append(`<p class="error">Error building model: ${errorMsg}</p>`);
                    } catch {
                        $('#result').append('<p class="error">Error building model</p>');
                    }
                    hideLoading();
                }
            });
        });

        $('#download-button').on('click', function() {
            if (modelBlob && modelFilename) {
                const url = window.URL.createObjectURL(modelBlob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', modelFilename);
                document.body.appendChild(link);
                link.click();
                link.remove();
            }
        });
    });
</script>
{% endblock %}